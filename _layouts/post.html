<!-- _layouts/post.html -->
<!DOCTYPE html>
<html>
<head>
  <title>{{ page.title }}</title>
</head>
<body>
  <h1>{{ page.title }}</h1>
  <p>{{ page.date | date_to_string }}</p>
  <div>{{ content }}</div>
  <hr>
  <h2>Comments</h2>
  <div id="comments-container">
    <!-- Comments will be loaded here by JavaScript -->
  </div>
  <a href="https://github.com/average-man/sblog/pull/{{ page.pr_number }}" target="_blank">Leave a Comment on GitHub</a>

  <!-- Script to fetch and display comments -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const REPO_NAME = 'average-man/sblog';
      const PR_NUMBER = {{ page.pr_number }};

      if (!PR_NUMBER) {
        return; // Don't run on pages without a PR number
      }

      const commentsContainer = document.getElementById('comments-container');
      const GITHUB_API_URL = `https://api.github.com/repos/${REPO_NAME}/issues/${PR_NUMBER}/comments`;

      commentsContainer.innerHTML = '<p>Loading comments...</p>';

      fetch(GITHUB_API_URL)
        .then(response => response.json())
        .then(comments => {
          if (!comments || comments.length === 0) {
            commentsContainer.innerHTML = '<p>No comments yet. Be the first to leave one!</p>';
            return;
          }

          let commentsHTML = '';
          comments.forEach(comment => {
            const commentBody = marked.parse(comment.body); 
            const commentDate = new Date(comment.created_at).toLocaleString();

            commentsHTML += `
              <div class="comment" style="border: 1px solid #ddd; padding: 10px; margin-top: 10px; border-radius: 5px;">
                <div class="comment-header" style="display: flex; align-items: center; gap: 10px; font-size: 0.9em; color: #555;">
                  <img src="${comment.user.avatar_url}" alt="${comment.user.login}" width="30" height="30" style="border-radius: 50%;">
                  <strong>${comment.user.login}</strong> commented on ${commentDate}
                </div>
                <div class="comment-body" style="margin-top: 10px;">
                  ${commentBody}
                </div>
              </div>
            `;
          });
          commentsContainer.innerHTML = commentsHTML;
        })
        .catch(error => {
          console.error('Error fetching comments:', error);
          commentsContainer.innerHTML = '<p>Could not load comments.</p>';
        });
    });
  </script>
</body>
</html>
